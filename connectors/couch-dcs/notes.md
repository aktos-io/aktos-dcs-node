# DB Installation

### Settings

In order to prevent unauthorized access to any database:

    [chttpd]
    require_valid_user = true


### VERY IMPORTANT: Testing the Installation

Following request MUST FAIL:

    curl http://localhost:5984/_session
    {"error":"unauthorized","reason":"Authentication required."}


# Creating Users:

With CouchDB >= 1.2.0:

Add a document to `_users` database:

```json
{
  "_id": "org.couchdb.user:dbreader",
  "name": "dbreader",
  "type": "user",
  "roles": [],
  "password": "plaintext_password"
}
```

# Database Security Settings:

Create a document with `_security` id in the database, like so:

```json
  {
    "_id": "_security",
    "couchdb_auth_only": true,
    "admins": {
      "names": [
        "someuser"
      ],
      "roles": [
        "_admin"
      ]
    },
    "members": {
      "names": [
        "someothername"
      ],
      "roles": [
        "somerole"
      ]
    }
  }
```
## Replication:

Design documents will only replicate if you are authenticated as an admin, or a db admin, on your target. Create a
document in _replicator db, like so:
```
  {
    "_id": "0aba5488715df9fb9ad02710fd0015a9",
    "_rev": "2-6c618c54b2c0dac58a97e9fc0d499d25",
    "user_ctx": {
      "name": "admin",
      "roles": [
        "_admin",
        "_reader",
        "_writer"
      ]
    },
    "source": {
      "headers": {
        "Authorization": "Basic d25yZWN0ZXNzaW5qdXN0b25zaWRlcnNlOmNjMWIyZjY2NTA0MWVhY2QxNGY0OTFkZWRhMzkwOTA0MThhY2QwN2M="
      },
      "url": "https://example.com/sourcedb"
    },
    "target": {
      "headers": {
        "Authorization": "Basic YWVhOmdoKzJ4"
      },
      "url": "http://127.0.0.1/targetdb"
    },
    "create_target": false,
    "continuous": true,
    "owner": "admin"
  }
```
Or (old format, may not work):

```
  {
    "_id": "some-random-id-or-leave-empty-to-be-autogenerated",
    "source": "https://theadmin:theadminpassword@example.cloudant.com/sourcedb",
    "target": "http://foo:bar@127.0.0.1:5984/targetdb",
    "create_target": true,
    "continuous": true
  }
```
